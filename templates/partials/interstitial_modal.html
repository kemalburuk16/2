{# /var/www/instavido/templates/partials/interstitial_modal.html #}
<div class="modal fade" id="ivInterstitialModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content" style="background:rgba(0,0,0,0.65);">
      <div class="modal-header border-0">
        <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body d-flex align-items-center justify-content-center p-0">
        <!-- Reklam içeriği buraya yüklenecek -->
        <div id="ivInterstitialContainer"
             class="w-100 h-100 d-flex align-items-center justify-content-center p-2">
          <!-- boş -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Ayarlar API ve Slot API uçları
  const CFG_URL  = "/srdr-proadmin/ads/api/interstitial.json";
  const SLOT_URL = "/srdr-proadmin/ads/api/slot/modal_fullscreen.html";

  // Oturum bazlı sayaç ve bekleme: sessionStorage & localStorage
  const SS_KEYS = {
    CLICK_COUNT: "iv_click_count",
    TARGET_AFTER_FIRST: "iv_target_after_first",
  };
  const LS_KEYS = {
    LAST_SHOWN_AT: "iv_inter_last_shown_at"
  };

  function getInt(v, def){ v = parseInt(v, 10); return isNaN(v) ? def : v; }

  async function getConfig(){
    try {
      const r = await fetch(CFG_URL, { credentials: "same-origin" });
      if(!r.ok) return null;
      return await r.json();
    } catch(e){ return null; }
  }

  function withinCooldown(cooldownMinutes){
    const last = getInt(localStorage.getItem(LS_KEYS.LAST_SHOWN_AT), 0);
    if(!last) return false;
    const ms = cooldownMinutes * 60 * 1000;
    return (Date.now() - last) < ms;
  }

  function setCooldownStamp(){
    localStorage.setItem(LS_KEYS.LAST_SHOWN_AT, String(Date.now()));
  }

  async function loadSlotHtml(){
    try {
      const r = await fetch(SLOT_URL, { credentials: "same-origin" });
      if(r.status === 204) return null; // slot pasif/boş
      if(!r.ok) return null;
      const html = await r.text();
      return html;
    } catch(e){ return null; }
  }

  function pickTarget(minA, maxA){
    // İlk tıklamadan sonra min-max arası rastgele bir sayı
    const val = Math.floor(Math.random() * (maxA - minA + 1)) + minA;
    sessionStorage.setItem(SS_KEYS.TARGET_AFTER_FIRST, String(val));
    return val;
  }

  function incClick(){
    const cur = getInt(sessionStorage.getItem(SS_KEYS.CLICK_COUNT), 0) + 1;
    sessionStorage.setItem(SS_KEYS.CLICK_COUNT, String(cur));
    return cur;
  }

  function getTarget(minA, maxA){
    let target = getInt(sessionStorage.getItem(SS_KEYS.TARGET_AFTER_FIRST), 0);
    if(!target){
      target = pickTarget(minA, maxA);
    }
    return target;
  }

  function shouldShow(cfg, clickCount){
    if(!cfg || !cfg.enabled) return false;
    if(withinCooldown(getInt(cfg.cooldown_minutes, 30))) return false;

    // İlk tıklama sonrası rastgele N: target
    const target = getTarget(getInt(cfg.min_after_first, 2), getInt(cfg.max_after_first, 5));
    return clickCount >= target;
  }

  async function maybeOpenInterstitial(cfg){
    const container = document.getElementById("ivInterstitialContainer");
    const modalEl   = document.getElementById("ivInterstitialModal");
    if(!container || !modalEl) return;

    const html = await loadSlotHtml();
    if(!html) return; // slot aktif değilse hiç açma

    container.innerHTML = html;

    // Bootstrap modal göster
    const m = new bootstrap.Modal(modalEl, { backdrop: true, keyboard: true });
    m.show();

    // Gösterildi: cooldown damgası at ve sayaçları sıfırla
    setCooldownStamp();
    sessionStorage.removeItem(SS_KEYS.CLICK_COUNT);
    sessionStorage.removeItem(SS_KEYS.TARGET_AFTER_FIRST);
  }

  // Sadece download sayfasında devrede (istersen base’e taşıyıp tüm sitede aktif edebilirsin)
  document.addEventListener("DOMContentLoaded", async function(){
    // Config’i önceden al
    const cfg = await getConfig();
    if(!cfg || !cfg.enabled) return;

    // İlk tıklamaları dinle
    document.body.addEventListener("click", async function(e){
      // Modal açıkken tekrar tetikleme
      const modalOpen = document.querySelector(".modal.show#ivInterstitialModal");
      if(modalOpen) return;

      const clicks = incClick();
      if(shouldShow(cfg, clicks)){
        await maybeOpenInterstitial(cfg);
      }
    }, { capture: true });
  });
})();
</script>
